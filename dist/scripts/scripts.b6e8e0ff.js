"use strict";function DialogController(a,b){a.hide=function(){b.hide()},a.cancel=function(){b.cancel()}}function mapEntries(a,b){for(var c=new Array,d=new Array,e=0;e<a.feed.entry.length;e++){var f=a.feed.entry[e];if("1"==f.gs$cell.col&&d.push(parseFloat(f.content.$t)),f.gs$cell.col==b){d.push(parseFloat(f.content.$t)),c.push(d);var d=new Array}}return c}angular.module("Authentication",[]),angular.module("intelliBarApp",["ngAnimate","ngCookies","ngResource","ngRoute","ngSanitize","ngTouch","ngMaterial","Authentication","ngCookies","ngStorage","ngMessages","ngMaterial","nvd3ChartDirectives"]).config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/main.html",controller:"MainCtrl"}).when("/dash",{templateUrl:"views/dash.html",controller:"DashCtrl"}).when("/outlets",{templateUrl:"views/outlets.html",controller:"OutletsCtrl"}).when("/login",{controller:"LoginController",templateUrl:"views/login.html",hideMenus:!0}).otherwise({redirectTo:"/login"})}]).config(["$mdThemingProvider",function(a){a.theme("default").primaryPalette("blue").accentPalette("orange")}]).run(["$rootScope","$location","$cookieStore","$http","AuthenticationService","$route",function(a,b,c,d){a.globals=c.get("globals")||{},a.globals.currentUser&&(d.defaults.headers.common.Authorization="Basic "+a.globals.currentUser.authdata,spark.login({accessToken:a.globals.currentUser.token})),a.$on("$locationChangeStart",function(){"/login"===b.path()||a.globals.currentUser||b.path("/login")})}]).filter("setDecimal",function(){return function(a,b){if(isNaN(a))return a;var c="1"+Array(+(b>0&&b+1)).join("0");return Math.round(a*c)/c}}),angular.module("intelliBarApp").controller("MainCtrl",["$scope",function(){}]),angular.module("intelliBarApp").controller("SparkCtrl",["$scope","$rootScope","$timeout","$location","$interval","$mdToast",function(a,b,c,d,e,f){a.day=1440,a.month=43200,a.hr=60,b.setBar=function(a){null!=a?a!=b.selectedBar?(b.selectedBar=a,g(a)):a==b.selectedBar&&(console.log("selected bar = selected"),f.show(f.simple().content("Already selected").position("top right"))):b.selectedBar=0};var g=function(c){b.bars||(a.dataLoading=!0);var d=spark.listDevices();d.then(function(a){var d=a;b.bars||(b.bars=d),c?h(c):(b.selectedBar=0,h(0))},function(d){a.dataLoading=!1,console.log("Load bars ",d),a.$digest(),g(b.selectedBar),b.bars[c].connected=!1})},h=function(c){1==b.bars[c].connected?(j(c),i(c),b.loadData()):(a.dataLoading=!1,a.$digest(),b.bars[c].connected=!1)},i=function(c){void 0==b.bars[c].relayStatus&&(b.bars[c].relayStatus=[0,0,0,0]),b.bars[c].getVariable("BarObject",function(d,e){if(d)a.dataLoading=!1,console.log("Load relay status",d),g(b.selectedBar);else{for(var f=0;4>f;f++)b.bars[c].relayStatus[f]="1"==e.result.charAt(f)?!0:!1;a.$digest(),a.dataLoading=!1}})},j=function(c){b.bars[c].getVariable("BarObject",function(d,e){if(d)a.$digest(),console.log("Load relay alias",d),g(b.selectedBar);else{b.bars[c].relayAlias||(b.bars[c].relayAlias=[0,0,0,0]);for(var f=4;8>f;f++)b.bars[c].relayAlias[f-4]=e.result.charAt(f);b.loadDeviceAlias(),a.$digest(),a.dataLoading=!1}})};b.updateAlias=function(a,c){var d=b.globals.currentUser.token,e="updateAlias",f="https://api.spark.io/v1/devices/"+c+"/"+e+"/";$.post(f,{params:a,access_token:d})},b.devices=["radio","outlet","computer","light","printer","tv","audio","dvr","console","other"],b.loadDeviceAlias=function(){b.device||(b.device=[],b.deviceN=[]);for(var c=0;4>c;c++)a.device[c]=a.devices[b.bars[b.selectedBar].relayAlias[c]];a.$digest()},b.updateDeviceAlias=function(){for(var c=0;4>c;c++)for(var d=0;10>d;d++)b.device[c]==b.devices[d]&&(b.deviceN[c]=d);console.log(a.deviceN);var e=a.deviceN.toString();console.log(e),b.updateAlias(e,b.bars[b.selectedBar].id)},b.loadData=function(){if(b.bars[b.selectedBar]&&1==b.bars[b.selectedBar].connected){a.loadInst();var c="1r_9-k7vnt_JoKbTpHGYy7Wk_eFSBMGs8z5PQ8dlpZTo",d="https://spreadsheets.google.com/feeds/cells/"+c+"/od6/public/values?alt=json-in-script&callback=?";$.getJSON(d,function(b){a.data1=[{key:"outlet 1",values:mapEntries(b,2)}],a.data2=[{key:"outlet 2",values:mapEntries(b,3)}],a.data3=[{key:"outlet 3",values:mapEntries(b,4)}],a.data4=[{key:"outlet 4",values:mapEntries(b,5)}],a.datat=[{key:"outlet 1",values:mapEntries(b,2)},{key:"outlet 2",values:mapEntries(b,3)},{key:"outlet 3",values:mapEntries(b,4)},{key:"outlet 4",values:mapEntries(b,5)}]}),a.$digest()}},a.sumData=function(a,b,c){if(a){c||(c=1);var d=0,e=a[0].values.length;b>e&&(b=e);for(var f=0;b>f;f++)d+=a[0].values[e-1][1]*c,e--;return d}return"..."},a.outletSwitch=function(a,c,d){var e=b.globals.currentUser.token,f="relay",g="r"+a.toString();g+=1==c?",HIGH":",LOW";var h="https://api.spark.io/v1/devices/"+d+"/"+f+"/";$.post(h,{params:g,access_token:e})},a.checkStatus=function(){if(!a.requestInProg)if(b.bars[b.selectedBar]){a.data1||b.loadData();var c=spark.listDevices();a.requestInProg=!0,c.then(function(c){a.requestInProg=!1;var d=c;d[b.selectedBar].connected!=b.bars[b.selectedBar].connected&&(b.bars[b.selectedBar].connected=d[b.selectedBar].connected,a.dataLoading=!0,b.loadSpark())},function(c){a.requestInProg=!1,console.log("check status: ",c),a.$digest(),b.loadSpark()})}else b.loadSpark()},a.loadInst=function(){a.requestInProg||b.bars[b.selectedBar]&&1==b.bars[b.selectedBar].connected&&(a.requestInProg=!0,b.bars[b.selectedBar].inst||(b.bars[b.selectedBar].inst={}),b.bars[b.selectedBar].getVariable("power",function(c,d){c?(a.$digest(),a.requestInProg=!1,console.log("Loading bars:",c),g(b.selectedBar)):(b.bars[b.selectedBar].inst=JSON.parse(d.result),a.totalPower=b.bars[b.selectedBar].inst.data1+b.bars[b.selectedBar].inst.data2+b.bars[b.selectedBar].inst.data3+b.bars[b.selectedBar].inst.data4,a.$digest(),a.requestInProg=!1)}))},b.loadSpark=function(){g(b.selectedBar),a.intervalFunction(),a.intervalFunction2(),a.intervalFunction3(),b.setBar(null)},a.intervalFunction=function(){c(function(){b.loadData(),a.intervalFunction()},6e4)},a.intervalFunction2=function(){c(function(){a.checkStatus(),a.intervalFunction2()},1e4)},a.intervalFunction3=function(){c(function(){a.loadInst(),a.intervalFunction3()},12e3)}}]),angular.module("intelliBarApp").controller("DashCtrl",["$scope","$rootScope",function(a){a.xAxisTickFormat=function(){return function(a){return d3.time.format("%x")(new Date(a))}},a.toolTipContentFunction=function(){return function(a,b,c){return console.log("tooltip content"),"Super New Tooltip<h1>"+a+"</h1><p>"+c+" at "+b+"</p>"}}}]),angular.module("intelliBarApp").controller("NavController",["$scope","$mdSidenav","$location","$rootScope","$route","$mdDialog",function(a,b,c,d,e,f){a.tapHandler=function(){document.getElementById("modal").toggle(),console.log("got here")},a.toggleLeftMenu=function(){b("left").toggle()},a.openLeftMenu=function(){b("left").open()},a.closeLeftMenu=function(){b("left").close()},a.selected=1,a.icon=function(){return 1==a.selected?"icon-expand-more":0==a.selected?"icon-expand-less":void 0},a.toggle=function(){a.selected=!a.selected},a.bodyScroll=function(){document.body.style.position=b("left").isOpen()?"fixed":"relative"},a.isActive=function(a){return a===c.path()},a.statusIcon=function(a){return 1==a?"icon-radio-button-on md-primary-color":"icon-radio-button-off"},a.showModal=function(b){f.show({controller:DialogController,templateUrl:"views/connect.html",targetEvent:b}),a.closeLeftMenu()},a.hide=function(){f.hide()},a.cancel=function(){f.cancel()}}]),angular.module("intelliBarApp").controller("OutletsCtrl",["$scope","$filter","$rootScope",function(a){a.tabs=[{title:"One",url:"one.tpl.html"},{title:"Two",url:"two.tpl.html"},{title:"Three",url:"three.tpl.html"},{title:"Four",url:"four.tpl.html"}],a.currentTab="one.tpl.html",a.onClickTab=function(b){a.currentTab=b.url},a.isActiveTab=function(b){return b==a.currentTab},a.xAxisTickFormat=function(){return function(a){return d3.time.format("%X")(new Date(a))}},a.toolTipContentFunction=function(){return function(a,b,c){return console.log("tooltip content"),"Super New Tooltip<h1>"+a+"</h1><p>"+c+" at "+b+"</p>"}}}]),angular.module("Authentication").controller("LoginController",["$scope","$rootScope","$location","AuthenticationService",function(a,b,c,d){d.ClearCredentials(),a.login=function(){a.dataLoading=!0,d.Login(a.username,a.password,function(b){b.success?(d.SetCredentials(a.username,a.password,b.token),c.path("/")):(a.error=b.message,a.dataLoading=!1)})},a.createUser=function(){a.dataLoading=!0,d.CreateUser(a.username,a.password,function(b){a.error=b.message,console.log(b.message),a.dataLoading=!1})}}]),angular.module("Authentication").factory("AuthenticationService",["Base64","$http","$cookieStore","$rootScope","$timeout","$window",function(a,b,c,d,e){var f={};return f.CreateUser=function(a,b,c){var d={},f=function(a,b){e(function(){a?d.message=a.message:b.errors?(d={success:!0},d.message=b.errors,console.log("Success",b)):d.message="Successfully Registered",c(d)},1e3)};spark.createUser(a,b,f)},f.Login=function(a,b,c){var d=function(a,b){var d={};e(function(){a?(console.log(a),d.message="Username or password is incorrect"):(d={success:!0,token:b.access_token},console.log("API call login completed on callback:",b)),c(d)},1e3)};spark.login({username:a,password:b},d)},f.SetCredentials=function(e,f,g){var h=a.encode(e+":"+f);d.globals={currentUser:{username:e,token:g,authdata:h}},b.defaults.headers.common.Authorization="Basic "+h,c.put("globals",d.globals)},f.ClearCredentials=function(){d.globals={},c.remove("globals"),b.defaults.headers.common.Authorization="Basic "},f}]).factory("Base64",function(){var a="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";return{encode:function(b){var c,d,e,f,g,h="",i="",j="",k=0;do c=b.charCodeAt(k++),d=b.charCodeAt(k++),i=b.charCodeAt(k++),e=c>>2,f=(3&c)<<4|d>>4,g=(15&d)<<2|i>>6,j=63&i,isNaN(d)?g=j=64:isNaN(i)&&(j=64),h=h+a.charAt(e)+a.charAt(f)+a.charAt(g)+a.charAt(j),c=d=i="",e=f=g=j="";while(k<b.length);return h},decode:function(b){var c,d,e,f,g,h="",i="",j="",k=0,l=/[^A-Za-z0-9\+\/\=]/g;l.exec(b)&&window.alert("There were invalid base64 characters in the input text.\nValid base64 characters are A-Z, a-z, 0-9, '+', '/',and '='\nExpect errors in decoding."),b=b.replace(/[^A-Za-z0-9\+\/\=]/g,"");do e=a.indexOf(b.charAt(k++)),f=a.indexOf(b.charAt(k++)),g=a.indexOf(b.charAt(k++)),j=a.indexOf(b.charAt(k++)),c=e<<2|f>>4,d=(15&f)<<4|g>>2,i=(3&g)<<6|j,h+=String.fromCharCode(c),64!=g&&(h+=String.fromCharCode(d)),64!=j&&(h+=String.fromCharCode(i)),c=d=i="",e=f=g=j="";while(k<b.length);return h}}});